# TuringOS 架构硬化落地执行方案 (Cycle 11-13)

基于 Cycle 01-10 跑测审计数据及《BIBLE》核心论述，当前系统的根因不在于心智流形理论模型，而在于工程侧缺乏 OS 级的“物理防弹衣”。以下为强干预硬化落地方案：

## 一、 核心失败根因排序与取证

1. **讨好型停机幻觉 (Pleasing HALT Illusion)**
   - **证据**: Cycle 07 及后续日志（`04_test_commands.txt`）高频出现 `sys://trap/halt_guard`。Cycle 09/10 在存在 `missing file: 12, text mismatch: 6` 的情况下依然强行申请 HALT。
   - **定性**: LLM 缺乏物理世界验证，企图越过测试直接宣告胜利。
2. **内容契约撕裂 (Lazy Write / Content Mismatch)**
   - **证据**: `05_test_results.md` 显示主失败模式转移为 `text_mismatch`（Cycle 10 有 6 处，Cycle 07 有 13 处）。
   - **定性**: 大模型在覆写文件时偷懒使用代码省略符（`// ... existing code`），导致文件物理毁坏。
3. **陷入局部死锁与递归修复失败 (Infinite Loop / Panic Reset Needed)**
   - **证据**: Cycle 04 `recursive_fix` 完成度为 `0`；Cycle 10 的陷阱统计显示 `IO_FAULT=3.6667, PAGE_FAULT=3.6667` 居高不下。
   - **定性**: 面对同类报错，LLM 缺乏外部强行打断机制，陷入同一错误思路的无限重试。
4. **API 不稳定导致因果链断裂 (API Circuit Broken)**
   - **证据**: Cycle 05 `api_recovered` 以及 `health/kimi_api_health_*` 探针数据。
   - **定性**: 网络抖动被 OS 误认为逻辑致命错误，破坏了状态机的连续性。
5. **打点计划与产出工件脱节 (Plan/Artifact Desync)**
   - **证据**: Cycle 10 计划打点 `plan_avg=0.377`，但实际完成度 `completion_avg=0.0833`。
   - **定性**: 执行引擎过度乐观，状态寄存器 `$q$` 中的 Todo 列表更新缺乏严格校验。

## 二、 双 LLM 协作架构：状态机与职责边界

引入 **Kimi（执行内核）** 与 **Gemini（审计神谕）** 的双层调度模型：

| 角色 | 组件映射 | 核心职责与操作权限 | 边界与限制 |
| :--- | :--- | :--- | :--- |
| **Kimi** | `\Psi_{Turing}` 转移函数 | 读写文件、执行 Shell、更新 Todo、推进 `$q$`。 | **受限：** 无法自行通过 HALT。所有 WRITE 操作受 OS 级拦截。 |
| **Gemini** | `Verification Gate` | 在 Kimi 申请 HALT 或提交大版本时被触发，校验 Artifacts 和测试覆盖率。 | **只读：** 只能输出 `Pass/Fail` 及诊断反馈注入 Kimi 的 `$q$`，不能直接写代码。 |

**协作流 (State Machine):**
`Kimi Act` -> `Kimi 申请 HALT` -> `Engine 挂起线程` -> `Gemini 审计代码与测试输出` -> `[Pass] OS 停机交付 / [Fail] 将拒绝理由以 Trap 形式打回给 Kimi`

## 三、 具体改动清单（文件到函数级）

### 1. `src/kernel/engine.ts` (内核调度拦截)
- **函数**: `executeSyscall(syscall)` 或主执行循环 `step()`
  - **注入 TDD 绝对停机契约 (HALT Gate)**: 
    - 拦截 `syscall.op === 'HALT'`。检查 `l1TraceBuffer` 最近 3-5 步是否包含终端命令（如 `npm test`, `cat`, `python`）。若无，抛出陷阱：`sys://trap/illegal_halt` 并附带强硬提示语要求先执行测试。
  - **注入死锁夺权 (Panic Reset)**:
    - 增加 `watchdog` 机制。记录最近 5 次 `syscall` 的报错哈希，如果相同报错连续出现 3 次以上，强行覆盖 `$q$` 的指令栈，抛出：`sys://trap/panic_reset`，要求立刻放弃当前路径并查阅文档。

### 2. `src/runtime/file-execution-contract.ts` (物理读写契约)
- **函数**: `validateContent(content)` 或写入动作的拦截器
  - **注入反偷懒写入屏障 (Lazy Write Trap)**:
    - 对预备写入的文件内容执行正则检查，匹配 `// ... existing`, `/* ...`, `此处省略` 等标记。
    - 命中则拦截写入，抛出：`sys://trap/lazy_write`，系统提示：“拒绝写入！文件将被损毁，必须全量输出完整代码。”

### 3. `src/oracle/universal-oracle.ts` (硬件级容错)
- **函数**: `collapse(discipline, q, s)` 或 `callLLM()`
  - **注入 API 断路器与时钟冻结 (Circuit Breaker)**:
    - 捕获 Fetch 层的 `429`, `502`, `timeout` 异常。
    - 剥离对上层 OS 的报错抛出，内部实现 `while` 循环 + 指数退避 (Exponential Backoff, 2s/4s/8s...上限60s)，直到成功。并打印日志 `[HARDWARE BROWNOUT] 冻结时钟...`。

### 4. `src/bench/os-longrun.ts` (基准测试主控)
- **函数**: `evaluate()` / 任务终态结算逻辑
  - **接入 Gemini 审计逻辑**: 捕获 Kimi 引擎最终的 HALT 状态，调用 Gemini 接口对 `05_test_results.md` 及工作区 diff 结果进行判定。只有 Gemini 判定 `Pass` 才计入 benchmark 成功率。

## 四、 Cycle 11-13 量化验收门槛 (KPI)

基于当前全零通过的底盘，设立三阶递进 KPI：

| 指标 | 当前 (Cycle 10) | Cycle 11 (跑通流形) | Cycle 12 (清除幻觉) | Cycle 13 (稳定交付) |
| :--- | :--- | :--- | :--- | :--- |
| **Passed / Runs** | 0 / 3 | **>= 1 / 3** | **>= 2 / 3** | **3 / 3** |
| **Completion Avg** | 0.0833 | > 0.40 | > 0.70 | 1.00 |
| **Trap: Lazy Write** | 隐性高频导致破坏 | 拦截命中率 100% | LLM 自动修正成功率 >90%| 触发次数降至 < 1 |
| **Trap: Illegal HALT** | 5.3+ | 拦截命中率 100% | 强制测试率 > 80% | 主动测试习惯形成 |
| **API 宕机中断数** | 频发 | 0 (均被底层熔断器吞噬) | 0 | 0 |

## 五、 失败回滚策略 (Fallbacks)

为防止强约束导致系统卡死，引入两级回滚机制：

1. **软回滚 (Git 历史时空回溯)**
   - **触发条件**: 当 `Gemini Audit` 连续 3 次拒绝 Kimi 的 HALT 请求，或 `Panic Reset` 单轮触发 >3 次。
   - **执行动作**: 调用宿主命令 `git reset --hard HEAD~1` 将工作区文件还原到上一个安全节点。清空 Kimi 当前任务的受污染状态 `$q$`，并注入：“已回滚时空，之前的思路是死胡同，请重新分析”。
2. **硬回滚 (Feature Flag 降级)**
   - **触发条件**: 如果上述三大陷阱门槛过高，导致 Cycle 11 中 Completion Avg 跌至 `0`（系统彻底不敢动）。
   - **执行动作**: 通过环境变量（如 `DISABLE_LAZY_WRITE_TRAP=1`）暂时降级为 Warning 而非 Error，优先保障状态机（`$q$`）的流转，后续通过微调 LLM 的 System Prompt 缓和处理。
