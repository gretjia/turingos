# TuringOS Cycle01-10 架构审计报告

## 1) 根因排序（Top 5）

| 排序 | 根因 | 证据 | 影响权重 |
|:---|:---|:---|:---:|
| R1 | **HALT守卫与工件实际内容脱节** | `src/runtime/file-execution-contract.ts:91-126` HALT校验仅检查标记存在，不校验内容精确度；Cycle07-10多次`sys://trap/halt_guard`触发 | 35% |
| R2 | **step-ready校验缺乏Gemini审计前置** | `src/kernel/engine.ts:189-219` 合同注入时无内容审计环节；Cycle08-10 `text_mismatch`持续10+/cycle | 30% |
| R3 | **IO/PAGE trap高频导致执行中断** | Cycle10 `traps_avg`: IO_FAULT=3.6667, PAGE_FAULT=3.6667；`src/kernel/engine.ts:272-291` 错误恢复未区分可恢复/致命 | 20% |
| R4 | **plan_avg波动大(0.17-1.0)说明计划稳定性不足** | Cycle08 `plan_avg=0.1706` vs Cycle06 `plan_avg=1`；`src/bench/os-longrun.ts:145-155` step-file映射硬编码 | 10% |
| R5 | **DONE append归一化与验收时序竞态** | `src/kernel/engine.ts:67-107` 归一化逻辑；Cycle09 `missing_file:9`与`text_mismatch:10`并存 | 5% |

---

## 2) 双LLM协作架构：Kimi执行 + Gemini审计

### 2.1 状态机

```
┌─────────┐    plan_ready    ┌─────────┐   kimi_execute   ┌─────────┐
│  IDLE   │ ───────────────→ │ PLANNED │ ───────────────→ │ EXEC_K  │
└─────────┘                  └─────────┘                  └────┬────┘
     ↑                                                         │
     └─────────────────────────────────────────────────────────┘
                              done_kimi
┌─────────┐   gemini_audit   ┌─────────┐   audit_pass   ┌─────────┐
│ HALTED  │ ←─────────────── │ AUDIT_G │ ←───────────── │ DONE_K  │
└────┬────┘                  └─────────┘                └─────────┘
     │ audit_fail ─┐
     └─────────────┘→ retry_kimi ─→ [EXEC_K] (max 2次)
                      
异常路径:
  EXEC_K ──trap(IO/PAGE)──→ RECOVER ──可恢复──→ EXEC_K
                              └──致命──→ FAILED → 人工介入
```

### 2.2 职责边界

| 维度 | Kimi (执行LLM) | Gemini (审计LLM) |
|:---|:---|:---|
| **核心职责** | 代码生成、文件写入、DONE标记 | 内容精确度校验、合同合规审计 |
| **输入** | `stepContext` + `fileContract` | `filePath` + `expectedPattern` + `kimiOutput` |
| **输出** | `fileContent` + `doneMarker` | `auditReport: {pass, diff, severity}` |
| **决策权** | 执行路径选择、错误恢复尝试 | 放行/拦截HALT、强制重写指令 |
| **超时** | 60s/step | 30s/file |
| **熔断** | 连续3次IO_FAULT→转人工 | 连续2次audit_fail→标记RISK_HALT |

### 2.3 新增接口

```typescript
// src/kernel/types.ts:34-50 扩展
interface GeminiAuditRequest {
  filePath: string;
  kimiContent: string;
  stepExpectation: StepContract;
  auditMode: 'strict' | 'lenient'; // strict用于最终HALT
}

interface GeminiAuditResult {
  passed: boolean;
  diffLines: Array<{line: number; expected: string; actual: string}>;
  contentHash: string; // 用于防篡改
  retryHint?: string;  // 指导Kimi重写
}
```

---

## 3) 具体改动清单

### 3.1 文件级变更矩阵

| 文件 | 函数/区间 | 变更类型 | 具体改动 |
|:---|:---|:---:|:---|
| `src/kernel/types.ts` | L34-40 | 扩展 | 新增`GeminiAuditRequest/Result`接口定义 |
| `src/kernel/types.ts` | 新增L41-55 | 新增 | 定义`AuditState`枚举、`DualLLMContext`类型 |
| `src/runtime/file-execution-contract.ts` | L56-89 | 重构 | `validateStepDone()`拆分：先Gemini审计，后HALT校验 |
| `src/runtime/file-execution-contract.ts` | L91-126 | 重构 | `validateHalt()`增加`auditHash`参数，不匹配则拒绝 |
| `src/runtime/file-execution-contract.ts` | 新增L140-180 | 新增 | `invokeGeminiAudit()`函数：调用Gemini API，解析diff |
| `src/kernel/engine.ts` | L67-107 | 修改 | `normalizeDoneAppend()`增加`preAudit`钩子 |
| `src/kernel/engine.ts` | L189-219 | 重构 | `injectContract()`改为双LLM编排：Kimi执行→Gemini审计→结果合并 |
| `src/kernel/engine.ts` | L272-291 | 修改 | `handleTrap()`区分`RECOVERABLE_TRAPS = [IO_FAULT, PAGE_FAULT]` |
| `src/kernel/engine.ts` | 新增L292-310 | 新增 | `scheduleGeminiAudit()`异步审计调度 |
| `src/bench/os-longrun.ts` | L145-155 | 修改 | `stepFileMap`增加`expectedPattern`字段（正则/片段） |
| `src/bench/os-longrun.ts` | L219-224 | 修改 | `runStep()`调用链插入`await auditStep()` |
| `src/bench/os-longrun.ts` | L270-281 | 修改 | `verifyCompletion()`使用Gemini的`contentHash`比对 |
| `src/bench/os-longrun.ts` | L351-360 | 修改 | 新增`auditReport`持久化到`post_summary.json` |

### 3.2 关键代码片段

**`src/runtime/file-execution-contract.ts:56-89` 重构后**

```typescript
async function validateStepDone(
  ctx: ExecutionContext,
  step: StepContract
): Promise<ValidationResult> {
  // NEW: 强制Gemini审计前置
  const audit = await invokeGeminiAudit({
    filePath: step.targetFile,
    kimiContent: await readFile(step.targetFile),
    stepExpectation: step,
    auditMode: 'lenient' // 步骤中允许部分匹配
  });
  
  if (!audit.passed && audit.diffLines.length > 3) {
    return { valid: false, code: 'AUDIT_FAIL', retryHint: audit.retryHint };
  }
  
  // 原DONE校验，增加auditHash绑定
  const doneMarker = generateDoneMarker(step.id, audit.contentHash);
  return appendDoneMarker(ctx, doneMarker);
}
```

**`src/kernel/engine.ts:189-219` 重构后**

```typescript
async function injectContract(ctx: DualLLMContext): Promise<void> {
  // Phase 1: Kimi执行
  const kimiResult = await kimiGenerate({
    prompt: buildExecutionPrompt(ctx.step),
    timeoutMs: 60000
  });
  
  // Phase 2: Gemini审计（阻塞HALT路径）
  const auditResult = await scheduleGeminiAudit({
    filePath: kimiResult.writtenFiles,
    expected: ctx.step.expectedPatterns
  });
  
  // Phase 3: 结果仲裁
  if (!auditResult.passed) {
    ctx.retryCount++;
    if (ctx.retryCount <= 2) {
      // 反馈Gemini的retryHint给Kimi
      return injectContract({...ctx, feedback: auditResult.retryHint});
    }
    throw new HaltGuardRejection('AUDIT_MAX_RETRY', auditResult);
  }
  
  // 审计通过，继续HALT守卫
  await proceedToHalt(ctx, auditResult.contentHash);
}
```

---

## 4) Cycle11-13 量化验收门槛（KPI）

### 4.1 分阶段目标

| 指标 | Cycle11 | Cycle12 | Cycle13 | 测量来源 |
|:---|:---:|:---:|:---:|:---|
| **passed/runs** | ≥1/3 | ≥2/3 | 3/3 | `post_summary.json` |
| **completion_avg** | ≥0.33 | ≥0.67 | ≥0.90 | `post_summary.json` |
| **text_mismatch/cycle** | ≤5 | ≤2 | 0 | `05_test_results.md` |
| **missing_file/cycle** | ≤3 | ≤1 | 0 | `05_test_results.md` |
| **audit_pass_rate** | ≥70% | ≥85% | ≥95% | 新增`auditReport`字段 |
| **trap_recovery_success** | ≥60% | ≥80% | ≥90% | `IO_FAULT`/`PAGE_FAULT`→成功恢复比例 |
| **plan_avg稳定性** | 0.6-1.0 | 0.7-1.0 | 0.8-1.0 | 方差<0.1 |
| **HALT_guard拒绝率** | ≤30% | ≤15% | ≤5% | `sys://trap/halt_guard`触发次数 |

### 4.2 强制终止条件（任一条触发即停）

- `passed=0/3` 且 `text_mismatch≥10`（Cycle11-12）
- `audit_pass_rate<50%`（Gemini审计机制失效）
- `kimi_api_health<8/10`（基础设施退化）
- 单cycle运行时间>30分钟（死锁风险）

---

## 5) 失败回滚策略

### 5.1 分层回滚

| 层级 | 触发条件 | 回滚动作 | 恢复时间 |
|:---|:---|:---|:---:|
| **L1: 步骤级** | 单step audit_fail | 用`retryHint`重试Kimi，保留上下文 | <2min |
| **L2: cycle级** | cycle结束passed=0 | 回滚到`plan_ready`状态，保留文件系统 | <5min |
| **L3: 机制级** | audit_pass_rate<50%连续2cycle | 禁用Gemini审计，回退到Cycle10单LLM模式 | <10min |
| **L4: 版本级** | L3回滚后仍passed=0 | `git checkout cycle10-stable`，完全回退 | <15min |

### 5.2 回滚操作命令

```bash
# L3机制回滚：禁用Gemini审计
echo '{"dual_llm_enabled": false}' > config/runtime.override.json
npm run cycle:resume -- --from=plan_ready

# L4版本回滚
git fetch origin
git checkout cycle10-stable -- src/runtime/file-execution-contract.ts src/kernel/engine.ts
npm run rebuild && npm run cycle:restart
```

### 5.3 数据保留

- 所有回滚前状态自动归档：`benchmarks/audits/rollback/<timestamp>/`
- Gemini审计日志强制保留，用于根因分析
- 回滚决策需人工确认（L3/L4）或自动执行（L1/L2）

---

## 附录：Cycle11首次运行检查清单

- [ ] `config/gemini.api.key` 已配置且健康检查通过
- [ ] `src/runtime/gemini-audit-adapter.ts` 新增文件已编译
- [ ] `benchmarks/audits/cycles/` 目录可写
- [ ] 回滚脚本 `scripts/rollback-l3.sh` 可执行
- [ ] 人工值班人员已确认联系方式
